let VERSION="V1.63 / 02.02.2025",COPYRIGHT="(C)JoEmbedded.de";async function initOptPolyfill(){var e,a;1<window.jdDebug&&(e="./js_dev/jsQR.min.js",!0===(await fetch(e)).ok?((a=document.createElement("script")).src=e,document.head.appendChild(a),console.log("qrscanner.js Cozmo QR Emulation init (window.jdDebug: "+window.jdDebug+")"),cozmoOk=!0):console.log("qrscanner.js Cozmo QR Emulation not found!"))}let cozmoOk=!1;class cozmoQR{detect(e){var a,t=[],e=(void 0===this.icanvas&&(this.icanvas=new OffscreenCanvas(e.videoWidth,e.videoHeight),this.ctxIntern=this.icanvas.getContext("2d",{willReadFrequently:!0})),this.ctxIntern.drawImage(e,0,0,e.videoWidth,e.videoHeight),this.ctxIntern.getImageData(0,0,this.icanvas.width,this.icanvas.height)),e=jsQR(e.data,e.width,e.height,{inversionAttempts:"dontInvert"});return e&&((a=[]).push(e.location.topLeftCorner),a.push(e.location.topRightCorner),a.push(e.location.bottomRightCorner),a.push(e.location.bottomLeftCorner),e={rawValue:e.data,cornerPoints:a},t.push(e)),t}}let scanDialog=void 0,videoQuelle,scaledVideoCanvas,camSelector,btnTorch,qrhtml="<video style='display: none;' id='qroriginal-video' playsinline mute></video><div id='qrvideo-header'><select id='qrcam-selector'></select></div><button id='qrscanner-btnClose'>&#10006;</button><button id='qrscanner-btnTorch'>&#x1F4A1;</button><div style='text-align:center;'><canvas id='qrscaled-videocanvas'></canvas></div>";function initQrCodeDOM(){try{null==scanDialog&&((scanDialog=document.createElement("dialog")).id="qrscanner-dialog",scanDialog.innerHTML=qrhtml,document.body.appendChild(scanDialog),videoQuelle=document.getElementById("qroriginal-video"),scaledVideoCanvas=document.getElementById("qrscaled-videocanvas"),camSelector=document.getElementById("qrcam-selector"),document.getElementById("qrscanner-btnClose").addEventListener("click",closeCam),(btnTorch=document.getElementById("qrscanner-btnTorch")).addEventListener("click",torchOnOff))}catch(e){qrLogPrint&&qrLogPrint("ERROR(initCameras): "+e)}}let availableCameras=[],camStream=void 0,torchFlag=!1,barcodeDetector=void 0,barcodeScannerInit=!1,camUpdateInterval=50,qrLogPrint=console.log;function setQrLogPrint(e){qrLogPrint=e}let wakeLock=null,ctxCam=void 0,scaleWidth=0,scaleHeight=0,scaleVideo2Canvas=0,qrScanDialogOpen=!1,scannedResults=[];function clearScannedResults(){scannedResults=[]}let scanCallback=function(){return 1};function setScanCallback(e){scanCallback=e}async function initCameras(){qrLogPrint&&qrLogPrint("INFO: InitCamera");try{if(initQrCodeDOM(),"BarcodeDetector"in window)qrLogPrint&&qrLogPrint("Barcode API available!");else{var e;if(!(void 0!==window.jdDebug&&1<window.jdDebug&&cozmoOk))return e="ERROR: No Barcode API available",qrLogPrint&&qrLogPrint(e),e;qrLogPrint&&qrLogPrint("ERROR: No Barcode API available, Use Polyfill!"),window.BarcodeDetector=cozmoQR}barcodeDetector=new BarcodeDetector({formats:["qr_code"]});var a=await navigator.permissions.query({name:"camera"});if("denied"==a.state)throw"Camera Access denied";"granted"!==a.state&&(await navigator.mediaDevices.getUserMedia({video:!0,audio:!1})).getTracks().forEach(e=>{e.stop()});var t=await navigator.mediaDevices.enumerateDevices();if(!(availableCameras=t.filter(e=>"videoinput"===e.kind)).length)throw"No Camera(s) available on this device";qrLogPrint&&qrLogPrint(`Found ${availableCameras.length} Camera`+(1<availableCameras.length?"s":""));let r=0,n=0,i=0;availableCameras.forEach((e,a)=>{var t=document.createElement("option"),o=""==e.label?"(Unknown)":e.label;qrLogPrint&&qrLogPrint(`Camera${a}: '${o}'`),e.label.toLowerCase().includes("back")&&(r=a,o="Back",1<++n)&&(o+=`(${n})`),e.label.toLowerCase().includes("front")&&(o="Front",1<++i)&&(o+=`(${i})`),t.text=o,camSelector.add(t)}),camSelector.selectedIndex=r,camSelector.addEventListener("change",openSelectedCamera),screen.orientation.addEventListener("change",orientationChanged),barcodeScannerInit=!0}catch(e){return qrLogPrint&&qrLogPrint("ERROR(initCameras): "+e),e}}async function orientationChanged(){qrScanDialogOpen&&openSelectedCamera()}async function openSelectedCamera(){if(!barcodeScannerInit){var e=await initCameras();if("string"==typeof e)return e}qrLogPrint&&qrLogPrint("INFO: OpenCamera");try{if(!availableCameras.length)throw"No Camera(s) available on this device";qrScanDialogOpen=!0,scanDialog.showModal();var a=window.visualViewport,t=(qrLogPrint&&qrLogPrint(`Viewport: ${Math.floor(a.width)}x`+Math.floor(a.height)),camSelector.selectedIndex),o=(qrLogPrint&&qrLogPrint(`Open Camera${t}: '${availableCameras[t].label}'`),void 0!==camStream&&stopCam(),new Promise(e=>{videoQuelle.onloadeddata=e})),{videoWidth:r,videoHeight:n}=(camStream=await navigator.mediaDevices.getUserMedia({video:{deviceId:availableCameras[t].deviceId,width:{min:640,ideal:1920},height:{min:480,ideal:1080}}}),videoQuelle.srcObject=camStream,videoQuelle.play(),await o,torchFlag=!1,void 0===camStream.getVideoTracks()[0].getSettings().torch?btnTorch.style.display="none":btnTorch.style.display="block",videoQuelle),i=r/n,c=a.height/n,l=a.width/r;let e=.8;l<c?(e*=a.width,scaleWidth=Math.floor(e),scaleHeight=Math.floor(e/i)):(e*=a.height,scaleHeight=Math.floor(e),scaleWidth=Math.floor(e*i)),scaledVideoCanvas.height=scaleHeight,scaledVideoCanvas.width=scaleWidth,scaleVideo2Canvas=scaleWidth/r,qrLogPrint&&qrLogPrint(`Camera: ${r}x${n} Pixels (Aspect-Ratio: ${i.toFixed(2)})`),qrLogPrint&&qrLogPrint(`Canvas: ${scaleWidth}x${scaleHeight} Pixels`),ctxCam=scaledVideoCanvas.getContext("2d",{willReadFrequently:!0}),camWorkerCont=!0,camWorker(),"wakeLock"in navigator&&(wakeLock=await navigator.wakeLock.request("screen"))}catch(e){return qrLogPrint&&qrLogPrint("ERROR(openSelectedCamera): "+e),e}}let camWorkerCont=!1;async function camWorker(){try{if(videoQuelle.videoWidth&&videoQuelle.videoHeight){var e=await barcodeDetector.detect(videoQuelle);if(ctxCam.drawImage(videoQuelle,0,0,scaleWidth,scaleHeight),0<e.length?(ctxCam.lineWidth=5,e.every(async a=>{let t=a.rawValue.replace(/(\r\n|\n|\r)/gm," ");if(""!==t){scaledVideoCanvas.style.borderColor="darkgreen";var o=scannedResults.find(e=>e.qrValue===t);let e="red";if(o){var r=performance.now()-o.t0;o.scnt++,e=o.qcolor,1e3<r&&(2==o.accepted?e="chocolate":0<=o.accepted&&(e="darkgreen"))}else{r=await scanCallback(t);if(void 0===r)return camWorkerCont;2==r?e="orange":0<=r&&(qrLogPrint&&qrLogPrint(`Scanned: '${t}'`),e="lime"),scannedResults.push({qrValue:t,t0:performance.now(),scnt:0,accepted:r,qcolor:e}),0==r&&(camWorkerCont=!1)}ctxCam.strokeStyle=e;o=a.cornerPoints;ctxCam.beginPath(),o.forEach((e,a)=>{var t=e.x*scaleVideo2Canvas,e=e.y*scaleVideo2Canvas;a?ctxCam.lineTo(t,e):ctxCam.moveTo(t,e)}),ctxCam.closePath(),ctxCam.stroke()}return camWorkerCont})):scaledVideoCanvas.style.borderColor="darkgray",!camWorkerCont)return void closeCam()}}catch(e){return qrLogPrint&&qrLogPrint("ERROR(camWorker): "+e),void closeCam()}setTimeout(camWorker,camUpdateInterval)}function stopCam(){if(void 0!==camStream){qrLogPrint&&qrLogPrint("INFO: CloseCamera");try{camStream.getTracks().forEach(e=>{e.stop()}),wakeLock&&wakeLock.release().then(()=>{wakeLock=null})}catch(e){qrLogPrint&&qrLogPrint("ERROR(stopCam): "+e)}videoQuelle.srcObject=null,camStream=void 0,ctxCam.rect(0,0,scaleWidth,scaleHeight),ctxCam.fillStyle="dimgray",ctxCam.fill(),scaledVideoCanvas.style.borderColor="darkgray"}}function closeCam(){stopCam(),scanDialog.close(),qrScanDialogOpen=!1}async function setTorch(e){torchFlag=e;e=camStream.getVideoTracks()[0];await e.applyConstraints({torch:torchFlag}),qrLogPrint&&qrLogPrint("Torch: "+torchFlag+": "+e.getSettings().torch)}async function torchOnOff(){setTorch(!torchFlag)}async function torchOff(){setTorch(!1)}async function qrSleepMs(a=1){return new Promise(e=>setTimeout(e,a))}async function scannerBusy(){for(;!0===qrScanDialogOpen;)await qrSleepMs(50)}initOptPolyfill(),console.log("qrscanner.js init, Version:"+VERSION);export{VERSION,COPYRIGHT,setQrLogPrint,scannedResults,clearScannedResults,setScanCallback,openSelectedCamera,torchOff,qrSleepMs,scannerBusy};